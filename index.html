<!DOCTYPE html>
<html>
<head>
<title>AutoBeats</title>
</head>
<body style="background:#333">
<script>
function AutoBeats(audioctx,dest,bpm,vol,keystr){
	function FMO(audioctx,dest,params) {
		this.v=[]; this.r=[]; this.Op=[]; this.Gain=[];
		this.Pan=audioctx.createPanner();
		this.Pan.panningModel="equalpower";
		for(var i=0;i<3;++i){
			this.v[i]=params[i*4+1];
			this.r[i]=params[i*4+2];
			this.Op[i]=audioctx.createOscillator();
			this.Gain[i]=audioctx.createGain();
			this.Op[i].type=["sine","sawtooth","square"][params[i*4+3]];
			this.Op[i].frequency.value=params[i*4];
			this.Gain[i].gain.value=0;
			this.Op[i].connect(this.Gain[i]);
			this.Op[i].start(0);
			if(i>0)
				this.Gain[i].connect(this.Op[i-1].frequency);
		}
		this.Gain[0].connect(this.Pan);
		var th=Math.PI*(params[12]-.5);
		this.Pan.setPosition(Math.sin(th),0,-Math.cos(th));
		this.Pan.connect(dest);
		this.trig=function(t) {
			for(var i=0;i<3;++i){
				this.Gain[i].gain.setValueAtTime(0,t-0.01);
				this.Gain[i].gain.linearRampToValueAtTime(this.v[i],t);
				this.Gain[i].gain.setTargetAtTime(0,t+0.01,this.r[i]);
			}
		};
	}
	function OSC(audioctx,dest,send,params){
		this.Osc=audioctx.createOscillator();
		this.Gain=audioctx.createGain();
		this.Send=audioctx.createGain();
		this.Filter=audioctx.createBiquadFilter();
		this.Pan=audioctx.createPanner();
		this.Osc.connect(this.Filter);
		this.Filter.connect(this.Gain);
		this.Filter.Q.value=15;
		this.Gain.connect(this.Pan);
		this.Pan.connect(dest);
		this.Pan.connect(this.Send);
		this.Send.connect(send);
		this.Send.gain.value=0.3;
		this.Gain.gain.value=0;
		this.Osc.type="square";
		this.Osc.start(0);
		this.oct=params.oct;
		this.cutoff=12;
		this.vol=params.vol;
		this.sus=params.sus;
		var th=Math.PI*(params.pan-.5);
		this.Pan.setPosition(Math.sin(th),0,-Math.cos(th));
		this.note=function(n,v,t){
			this.Gain.gain.setValueAtTime(0,t-0.01);
			this.Gain.gain.linearRampToValueAtTime(v*this.vol,t);
			this.Gain.gain.setTargetAtTime(0,t,this.sus);
			var f=440*Math.pow(2,(n-69+this.oct*12)/12);
			this.Osc.frequency.setValueAtTime(f,t);
			this.Filter.frequency.setValueAtTime(f*this.cutoff,t);
		}
		this.setTone=function(type,cutoff,q,sus){
			this.Osc.type=["sine","sawtooth","square","square"][type];
			this.cutoff=cutoff;
			this.Filter.Q.value=q;
			this.sus=sus;
		}
	}
	this.p0="54645466546654661020142454055466";
	this.s0=[
		[0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15],
		[0, 2, 4, 5, 7, 9,11,12,14,16,17,19,21,23,24,26],
		[0, 2, 4, 6, 8,10,12,14,16,18,20,22,24,26,28,30],
		[0, 2, 3, 5, 6, 8, 9,11,12,14,15,17,18,20,21,23]
	];
	this.b0=[90,110,120,140,160,180,220,240];
	this.getSeq=function(k,i){
		return Math.abs(Math.sin(this.h[0]*k*i)*100)|0;
	}
	this.setBPM=function(bpm){
		this.bpm=bpm;
		this.delay.delayTime.value=30/this.bpm;
	}
	this.setTitle=function(title){
		if(title.length==0)
			title="Hello, AutoBeats.";
		this.h=[];
		this.h[0]=title.length;
		this.h[1]=0;
		this.h[2]=[];
		this.h[3]=[];
		for(var i=0;i<this.h[0];++i)
			this.h[1]+=title.charCodeAt(i);
		for(var i=0;i<16;++i){
			this.h[2][i]=(Math.abs(Math.sin(this.h[0]*2222*i)*100))|0;
			this.h[3][i]=(Math.abs(Math.sin(this.h[0]*1234*i)*100))|0;
		}
		this.scale=this.s0[this.getSeq(4,1)&3];
		this.setBPM(this.b0[this.getSeq(this.h[1],4)&7]);
	}
	if(!audioctx){
		audioctx=new AudioContext();
		dest=audioctx.destination;
	}
	this.audioctx=audioctx;
	this.dest=dest;
	this.run=0;
	this.cur=0;
	this.meas=0;
	this.beat=0;
	this.vol=vol;
	this.Comp=audioctx.createDynamicsCompressor();
	this.scrproc=audioctx.createScriptProcessor(1024,2,2);
	this.scrproc.ab=this;
	this.delay=audioctx.createDelay();
	this.delayFb=audioctx.createGain();
	this.delayFb.gain.value=0.5;
	this.delay.delayTime=30/this.bpm;
	this.delay.connect(this.Comp);
	this.delay.connect(this.delayFb);
	this.delayFb.connect(this.delay);
	this.Comp.connect(dest);
	this.scrproc.onaudioprocess=function(e){
		var ab=this.ab;
		if(!ab.run){
			ab.o1.note(0,0,ab.cur);
			ab.o2.note(0,0,ab.cur);
			ab.o3.note(0,0,ab.cur);
			ab.meas=ab.beat=0;
			ab.cur=ab.audioctx.currentTime;
			return;
		}
		var st=0.25*120/ab.bpm;
		var t=ab.audioctx.currentTime;
		while(t>=ab.cur+st-0.1){
			ab.cur+=st;
			var pb=ab.getSeq(1,ab.meas)&3;
			var ps=ab.getSeq(2,ab.meas)&3;
			var ph=ab.getSeq(3,ab.meas)&3;
			var pn=ab.beat&7;
			if(ab.p0[pb*8+pn]&1) ab.bdo.trig(ab.cur);
			if(ab.p0[ps*8+pn]&2) ab.sdo.trig(ab.cur);
			if(ab.p0[ph*8+pn]&4) ab.hho.trig(ab.cur);
			var r1=ab.getSeq(2,ab.meas*2+ab.beat);
			var r2=ab.getSeq(3,ab.meas*2+ab.beat);
			var r3=ab.getSeq(4,ab.meas*2+ab.beat);
			ab.o1.note(ab.scale[(r1&15)]+57,r1&1,ab.cur);
			ab.o2.note(ab.scale[(r2&15)]+57,r2&1,ab.cur);
			ab.o3.note(ab.scale[(r3&15)]+57,r3&1,ab.cur);
			if(++ab.beat>=16){
				ab.beat=0;
				++ab.meas;
				ab.o1.setTone(ab.getSeq(4,ab.meas)&3,(ab.getSeq(5,ab.meas)&15)+4,(ab.getSeq(6,ab.meas)&15)+5,Math.pow(0.9,ab.getSeq(13,ab.meas)&31));
				ab.o2.setTone(ab.getSeq(7,ab.meas)&3,(ab.getSeq(8,ab.meas)&15)+4,(ab.getSeq(9,ab.meas)&15)+5,Math.pow(0.9,ab.getSeq(14,ab.meas)&31));
				ab.o3.setTone(ab.getSeq(10,ab.meas)&3,(ab.getSeq(11,ab.meas)&15)+4,(ab.getSeq(12,ab.meas)&15)+5,Math.pow(0.9,ab.getSeq(15,ab.meas)&31));
			}
		}
	};
	this.scrproc.connect(this.Comp);
	this.bdo=new FMO(audioctx,this.Comp,[25,1.,.05,2, 29,400,.01,0, 131,100,.001,0,0.5]);
	this.sdo=new FMO(audioctx,this.Comp,[213,.6,.1,0, 723,1900,.6,0, 140,800,.1,0,0.4]);
	this.hho=new FMO(audioctx,this.Comp,[2200,.3,.02,0, 423,3120,.5,0, 552,1800,.1,1,.7,0.6]);
	this.o1=new OSC(audioctx,this.Comp,this.delay,{'oct':-2,'vol':0.5,'pan':0.5,'sus':.1});
	this.o2=new OSC(audioctx,this.Comp,this.delay,{'oct':0,'vol':0.3,'pan':0.35,'sus':.1});
	this.o3=new OSC(audioctx,this.Comp,this.delay,{'oct':1,'vol':0.3,'pan':0.65,'sus':.1});
}
//------------------------
window.onload=function(){
	audioctx=new AudioContext();
	analyser=audioctx.createAnalyser();
	analyser.connect(audioctx.destination);
	beat=new AutoBeats(audioctx,analyser);
	Setup();
	var dat=new Uint8Array(128);
	var cv=document.getElementById("canvas");
	cv.style.weight="100%";
	var ctx=cv.getContext("2d");
	requestAnimationFrame(function(){
		analyser.getByteTimeDomainData(dat);
		ctx.fillStyle="#000";
		ctx.strokeStyle="#0f0";
		ctx.lineWidth=2;
		ctx.fillRect(0,0,512,512);
		ctx.beginPath();
		ctx.moveTo(0,256-(dat[0]-128));
		for(var i=0;i<128;++i)
			ctx.lineTo(i*4,256-(dat[i]-128));
		ctx.stroke();
		requestAnimationFrame(arguments.callee);
	});
};
function Play(){
	beat.run^=1;
}
function Setup(){
	beat.setTitle(document.getElementById("title").value);
	var bpm;
	if(document.getElementById("bpmauto").checked)
		bpm=beat.bpm;
	else
		bpm=document.getElementById("bpm").value;
	if(bpm)
		beat.setBPM(bpm);
	document.getElementById("bpm").value=bpm;
}
</script>
<div style="float:right;color:#888;background:#222;padding:5px;height:50px">
<b>AutoBeats</b> is a auto composer.<br/> Just need a 'Title', and optionally 'BPM'.<br/>
<a href="http://www.g200kg.com/">g200kg</a>
</div>
<h1 style="color:#ddd;height:50px">AutoBeats</h1>
<div style="background:#555;color:#ccc;padding:10px;margin:5px">
<table>
<tr><td>Title</td><td><input id="title" value="Hello, AutoBeats." onchange="Setup()"></input></td></tr>
<tr><td>BPM</td><td><input id="bpmauto" type="checkbox" checked onchange="Setup()"></input>auto  <input id="bpm" min="1" max="300" value="0" size="4" onchange="Setup()"></input></td></tr>
</table>
<button onclick="Play()">Play</button>
</div>
<canvas id="canvas" width="512" height="512" style="width:100%;height:400px">
</div>
</body>
</html>
